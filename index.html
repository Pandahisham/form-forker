<!DOCTYPE html>
<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
        <style type="text/css">
            body { font: 200 16px/18px 'helvetica',arial,sans-serif; max-width: 600px; margin: 50px auto; color: #000; padding: 10px 50px; border-left: 1px solid #f8f8f8; border-right: 1px solid #f8f8f8; min-height: 1000px; }
            h1 { font: 100 26px/30px 'helvetica',arial,sans-serif; font-weight: 100; margin: 0 0 20px 0;  color: #999; padding: 0px;  }
            #branching-form div.field p.info { font-size: 11px; background: rgba(0,0,0,0.3); padding: 2px 10px; color: #333; text-align: right; margin: 0 0 5px 0; }
            #branching-form div.field > div.field > p.info { background: rgba(0,0,0,0.2);  }
            #branching-form div.field > div.field > div.field > p.info { background: rgba(0,0,0,0.1); }
            #branching-form div.field p.info span.level { float: left; }
            #test { display: block; }
            #branching-form div.field { padding: 15px 0px 15px 15px; height: auto; transition: padding 0.2s ease 0.0s; }
            #branching-form div.field label { display: block; padding: 5px 0px; }
            #branching-form div.field input { width: 99%; height: 18px; }
            #branching-form div.field input[type="radio"] { display: inline-block; margin: 10px 5px; width: auto; vertical-align: middle; }
            #branching-form div.field.hidden { overflow: hidden; height: 0px; padding: 0px 0px 0px 15px; transition: padding 0.2s ease 0.0s; }
            #branching-form div.field span.custom-radio { border: 1px solid #bfbfbf; border-radius: 5px; display: inline-block; margin: 5px 0 10px 0px; font: bold 10px sans-serif; color: #717171; background-color: #ffffff;
            padding: 4px 9px; cursor:pointer; }
            #branching-form div.field span.custom-radio.radio-selected { background-color: #cbcbcb; }

            #fake-submit-button { background-color: #6288a5; border: 1px solid rgb(83, 118, 145); border-radius: 3px; font: 600 13px/20px 'helvetica',arial,sans-serif; text-transform: uppercase; padding: 5px 15px; max-width: 100px; text-align: center; margin: 0 auto; color: #fff; }
            #fake-submit-button:hover { background-color: #326891; border-color: #325c8a; cursor: pointer; }
            #fake-post-data { margin: 40px auto; max-width: 600px; font: 400 12px/16px 'courier',serif; word-wrap: break-word; }
            #fake-post-data h2 { font: 600 10px/16px 'helvetica',arial,sans-serif; color: #666; text-transform: uppercase; background-color: #eee; padding: 5px 10px 3px 10px; }
        </style>
    </head>
    <body>
        <div id="branching-form">
            <h1>Weee branching form</h1>

            <!-- Level 0 form field: person_age -->
            <div class="field">
                <label>How old are you?</label>
                <input type="text" class="fork" data-branching-fn="integerEval" name="person_age"  placeholder="Age" />

                <!-- Level 1 form fields: children of person_age -->
                <div class="field hidden" data-parent-branch="person_age" data-show-on-value="gte-3_and_lte-7">
                    <p class="info"><span class="level">Level 1</span> Person's age is <b>between 3 & 7</b></p>
                    <label>What's your favorite candy?</b></label>
                    <input type="text" class="fork" name="favorite_candy" data-branching-fn="stringEval" placeholder="Favorite candy" />

                    <!-- Level 2 form fields: children of favorite_candy -->
                    <div class="field hidden" data-parent-branch="favorite_candy" data-show-on-value=" StarBurst,skittles">
                       <p class="info"><span class="level">Level 2</span> Person's favorite candy is <b>starburst</b></p>
                        <label>What flavor?</b></label>
                        <input type="text" name="what_flavor_starburst" placeholder="What flavor?" />
                    </div>
                    <div class="field hidden" data-parent-branch="favorite_candy" data-show-on-value="chocolate">
                       <p class="info"><span class="level">Level 2</span> Person's favorite candy is <b>chocolate</b></p>
                        <label>Which chocolate bar?</b></label>
                        <input type="text" name="which_chocolate_bar" placeholder="Which chocolate bar?" />
                    </div>
                </div>

                <!-- Level 1 form fields: children of person_age -->
                <div class="field hidden" data-parent-branch="person_age" data-show-on-value="5">
                   <p class="info"><span class="level">Level 1</span> Person's age <b>equals 5</b></p>
                    <label>Did you start kindergarden this year?</label>
                    <input type="hidden"  class="fork" name="started_kindergarden_this_year"  data-branching-fn="stringEval" />
                    <span class="custom-radio"> YES</span>
                    <span class="custom-radio"> NO</span>

                    <!-- Level 2 form fields: children of started_kindergarden_this_year -->
                    <div class="field hidden" data-parent-branch="started_kindergarden_this_year" data-show-on-value="yes">
                       <p class="info"><span class="level">Level 2</span> Person <b>did</b> start kindergarden this year</p>
                        <label>What kindergarden do you go to?</b></label>
                        <input type="text" name="what_kindergarden" />
                    </div>
                </div>

                <!-- Level 1 form fields: children of person_age -->
                <div class="field hidden" data-parent-branch="person_age" data-show-on-value="gte-21">
                    <p class="info"><span class="level">Level 1</span>Person's age is <b>at least 21</b></p>
                    <label>Did you graduate college?</label>
                    <input type="radio" class="fork"  data-branching-fn="stringEval" name="graduated_college" value="1">Yes &nbsp;
                    <input type="radio" class="fork"  data-branching-fn="stringEval" name="graduated_college" value="2">No &nbsp;
                    <input type="radio" class="fork"  data-branching-fn="stringEval" name="graduated_college" value="3">Maybe

                    <!-- Level 2 form fields: children of started_kindergarden_this_year -->
                    <div class="field hidden" data-parent-branch="graduated_college" data-show-on-value="1">
                       <p class="info"><span class="level">Level 2</span> Person <b>did</b> graduate college</p>
                        <label>What college did you graduate from?</b></label>
                        <input type="text" name="graduated_from" />
                    </div>

                    <div class="field hidden" data-parent-branch="graduated_college" data-show-on-value="2,3">
                       <p class="info"><span class="level">Level 2</span> Person <b>did not</b> graduate college</p>
                        <label>What college would you like to attend?</b></label>
                        <input type="text" name="wants_to_graduate_from" />
                    </div>
                </div>
            </div>

            <!-- Level 0 form field: person_income -->
            <div class="field">
                <label>What is your annual income?</label>
                <select class="fork" data-branching-fn="stringEval" name="person_income">
                    <option value="under30">$0 - $30,000</option>
                    <option value="between30and60">$30,000 - $60,000</option>
                    <option value="between60and100">$60,000 - $100,000</option>
                    <option value="morethan100">More than $100,000</option>
                </select>

                <!-- Level 1 form fields: children of person_income -->
                <div class="field hidden" data-parent-branch="person_income" data-show-on-value="morethan100">
                    <p class="info"><span class="level">Level 1</span> Person earns <b>more than $100,000</b></p>
                    <label>How does it feel to be rich?</label>
                    <input type="text" name="being_rich" />
                </div>
            </div>
        </div>

        <div id="fake-submit-button">Submit</div>
        <div id="fake-post-data"></div>

        <script type="text/javascript">

            /*
            * Setup branching form as a constructor function to be called with the 'new' keyword
            * @param {object} form The jQuery DOM form element
            * @param {array} forks An array of the jQuery form elements that act as the 'forks in the road' for branching when their values change
            */
            function branchingForm(form, forks) {
                this.domForm = form,
                this.forks = forks,

                /* Gather any values from inputs that are currently displayed to submit */
                this.postData = function() {
                    var unhiddenFields = this.domForm.find('div:not(".hidden")'),
                    inputFieldsToSend = unhiddenFields.find('> input, > textarea, > select'),
                    postData = {};

                    _.each(inputFieldsToSend, function(input) {
                        var postVal;
                        ($(input).prop('type') === 'radio') ? postVal = $('input:checked').val() : postVal = $(input).val(); // if input is a radio button, only send the value of the checked radio

                        if (postVal) { // if the input value isn't blank, add a key to the postData object
                            postData[$(input).prop('name')] = postVal;
                         }
                    });

                    return postData;
                },


                this.util = {

                    /* Fake radio buttons so we can give them custom styling; will probaby need to support custom select menus, checkboxes, etc. in the future */
                    handleCustomRadios: function(e) {
                        var $elem = $(e.currentTarget), // radios span that was clicked on
                        $associatedInput = $elem.parent().find('> input'), // the input whose value needs to be toggled based on our span selection
                        selectedRadioVal = $.trim($elem.html()); // the innerHTML of our selected span

                        $associatedInput.val(selectedRadioVal); // set the hidden input value equal to the selected span
                        $associatedInput.trigger('change'); // manually trigger the change even on our input so we can evaluate it's value
                        $elem.addClass('radio-selected').siblings().removeClass('radio-selected');
                    },


                    /* Remove leading/trailing whitespace & convert to lowercase to ensure no false negatives when comparing strings */
                    cleanString: function(dirtyString) {
                        return dirtyString.toLowerCase().replace(/^\s+|\s+$/g,'');
                    },


                    /*
                     * Map string-based operators to their arithmetic equivalent and return the result of the evaluated expression
                     * @param {string} comparisonOperator The string-based comparison to convert to an arithmetic operator // possible values: gte, gt, lte, lt, eq, noteq
                     * @param {integer} userEnteredValue The current integer value a user has entered
                     * @param {integer} integerToCompareAgainst The integer we will compare the userEnteredValue to as specified by the child branch's data-show-on-value attribute
                     */
                    convertToArithmeticComparison:  function (comparisonOperator, userEnteredValue, integerToCompareAgainst) {
                        switch (comparisonOperator) {
                            case 'gte':
                                return (userEnteredValue >= integerToCompareAgainst)
                                break;
                            case 'gt':
                                return (userEnteredValue > integerToCompareAgainst)
                                break;
                            case 'lte':
                                return (userEnteredValue <= integerToCompareAgainst)
                                break;
                            case 'lt':
                                return (userEnteredValue < integerToCompareAgainst)
                                break;
                            case 'eq':
                                return (userEnteredValue == integerToCompareAgainst)
                                break;
                            case 'noteq':
                                return (userEnteredValue != integerToCompareAgainst)
                                break;
                        }
                    },


                    /*
                     * Parse the data-show-on-value attribute of child branches for integer evaluations.
                     * @param {integer} userEnteredValue The current integer value a user has entered into an input with dependent child branches
                     * @param {string} conditionsToBeMet The conditions to be met for showing a child branch, as specified by the child branch's
                                                     data-show-on-value attribute // possible values: gte-{int}, gt-{int}, lte-{int}, lt-{int}, eq-{int}, noteq-{int}
                     * @param {string} logicalOperator The logical operator to use when evaluating multiple conditions // possible values: _and_, _or_
                     */
                    parseNumericConditions: function (userEnteredValue, conditionsToBeMet, logicalOperator) {
                        var valuePassesConditions, loopingMethod;

                        /* If there are multiple conditions but the logical operator is an ||, we can return true after the first condition that passes.
                        /* If there is no logical operator (only 1 condition is specified), or it is an &&, we must loop through all conditions and only return true if all pass.
                        /* We will set the loopingMethod variable to either 'some' or 'every' depending on these conditions. See: http://underscorejs.org/#every */
                        (logicalOperator && logicalOperator === '_or_') ? loopingMethod = 'some' : loopingMethod = 'every';

                        /* Loop through the conditions that must be met to show a particular child branch */
                        valuePassesConditions = _[loopingMethod](conditionsToBeMet, function (condition) {
                            var condition = condition.split('-'),
                                comparisonOperator = condition[0], // gte, gt, lte, lt, eq, noteq
                                integerToCompareAgainst = condition[1]; // integer we will compare the userEnteredValue to

                            return this.convertToArithmeticComparison(comparisonOperator, userEnteredValue, integerToCompareAgainst);
                        }, this);
                        return valuePassesConditions;
                    },
                },


                /*
                 * Method for comparing integer values with arithmetic operators. This code is method is CRAZY.
                 * @param {object} opts Options containing references to the child branches and the user-entered value to be evaluated
                 */
                this.integerEval = function (opts) {
                    var userEnteredValue = parseInt(opts.userEnteredValue), // convert input value from string to integer
                        logicalOperator,
                        numericOperations,
                        conditionsForShowingChildBranch;

                    /* for each of the possible child branches, find the condition that must be met in order for them to be shown */
                    _.each(opts.childBranches, function (childBranch) {
                        var $childBranch = $(childBranch),
                        showOnValueAttribute = $(childBranch).data('show-on-value'),
                        conditionType = typeof showOnValueAttribute;

                        if (conditionType === 'string') {
                            if (showOnValueAttribute.indexOf(',') !== -1) { conditionType = 'integerArray'; }
                            if (showOnValueAttribute.match(/\_and\_|\_or\_/g) !== null) { conditionType = 'logicalExpression'; }
                        }

                        switch (conditionType) {
                            case 'number': // data-show-on-value="1"
                                numericOperations = ['eq-' + showOnValueAttribute];
                                break;

                            case 'string': // data-show-on-value="gte-8"
                                numericOperations = [showOnValueAttribute];
                                break;

                            case 'integerArray': // data-show-on-value="1,2,3,4,5"
                                conditionsForShowingChildBranch = showOnValueAttribute.split(',');
                                logicalOperator = '_or_';
                                numericOperations = [];
                                _.each(conditionsForShowingChildBranch, function(condition) {
                                    numericOperations.push('eq-' + condition);
                                });

                            case 'logicalExpression': // data-show-on-value="gte-3_and_lte-7"
                                conditionsForShowingChildBranch = showOnValueAttribute.split(/(\_and\_|\_or\_)/g);
                                logicalOperator = conditionsForShowingChildBranch[1]; // _and_, _or_
                                numericOperations = [conditionsForShowingChildBranch[0], conditionsForShowingChildBranch[2]]; // gte-{int}, gt-{int}, lte-{int}, lt-{int}, eq-{int}, noteq-{int}
                        }

                        childBranchShouldBeShown = this.util.parseNumericConditions(userEnteredValue, numericOperations, logicalOperator);
                        (childBranchShouldBeShown) ? $childBranch.removeClass('hidden').find('> div.field').removeClass('hidden') : $childBranch.addClass('hidden'); $childBranch.find('div.field').addClass('hidden');

                    }, this);
                },


                /*
                 * Compare string values. Will also work for boolean values by comparing their string equivalents, though this could get buggy.
                 * @param {object} opts Options containing references to the child branches and the user-entered value to be evaluated
                 */
                this.stringEval = function(opts) {
                    var self = this,
                    userEnteredValue = self.util.cleanString(opts.userEnteredValue);

                    _.each(opts.childBranches, function(childBranch) {
                        var $childBranch = $(childBranch),
                            conditionsForShowingChildBranch = $childBranch.data('show-on-value').toString().split(',');  // grab the conditions that must be true in order to show this child branch
                            conditionsForShowingChildBranch = _.map(conditionsForShowingChildBranch, function(condition) {
                                return self.util.cleanString(condition);
                            });
                            childBranchShouldBeShown = (conditionsForShowingChildBranch.indexOf(userEnteredValue) !== -1);
                            (childBranchShouldBeShown) ? $childBranch.removeClass('hidden').find('> div.field').removeClass('hidden') : $childBranch.addClass('hidden'); $childBranch.find('div.field').addClass('hidden');

                    })
                }
            };


            (function () {
                /* Instantiate new branching form object */
                var branchForm = new branchingForm($('#branching-form'), $('#branching-form .fork'));

                /* Attach change event handler to monitor the values of our branch forks & evaluate them with the appropriate branchForm method */
                _.each(branchForm.forks, function (fork) {
                    var branchingMethod = $(fork).data('branching-fn'); // determine the type of evaluation we need to do on the input value
                    if ($(fork).prop('type') === 'text') { $(fork).keyup(function() { $(fork).trigger('change'); }); }
                    $(fork).change(function (e) {
                        var opts = {
                            childBranches: $('#branching-form').find('div[data-parent-branch=' + $(fork).prop('name') + ']'),
                            userEnteredValue: $(fork).val()
                        }
                        branchForm[branchingMethod](opts);
                    });
                });

                /* Attach click event handler for custom radios */
                $('#branching-form').find('div span.custom-radio').click(function(e) {
                    branchForm.util.handleCustomRadios(e);
                });

                /* Stub submit button to display postData on form submit */
                $('#fake-submit-button').click(function(e) {
                    var stringifiedPostData = branchForm.postData();
                    stringifiedPostData = JSON.stringify(stringifiedPostData);
                    var radioVal = $(branchForm).find('input[type=radio').val();
                    $('#fake-post-data').html('<h2>Post Data on Submit:</h2>' + stringifiedPostData);
                });

            })();

        </script>
    </body>
</html>
